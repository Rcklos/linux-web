# IP协议

IP协议是TCP/IP协议族的核心协议，是socket网络编程的基础。

- IP头: 指定IP通信的源端IP、目的IP，指导IP分片和重组以及指定部分通信行为。
- IP数据包的路由与转发: 发生在除目标机器之外的所有主机和路由器上。

## 1. IP服务的特点

IP协议为上层协议提供无状态、无连接、不可靠的服务。

`无状态`: IP通信双方不同步传输数据的状态信息。发送、传输和接收都是相互独立、没有上下文关系的。

> 缺点：无法处理乱序和重复数据报

IP数据包的`标识字段`用以唯一标识一个IP数据报，但只是用于分片和重组，与顺序无关。

> 优点：简单、高效

`无连接`： IP通信双方都不长久地维持对方的任何信息。

> 需要每次发送数据的时候都要指定目的地址

`不可靠`: IP协议不能保证IP数据报准确地到达接收端，只承诺尽最大努力(best effort)。

## 2. IPv4头部结构

![IPv4头](http://cdn.lentme.cn/20220809200549.png)

IPv4头长度通常为`20字节`(含与可变长选项部分时大于20字节)

- 版本号：IPv4的值是4
- 头部长度：单位是32bit(4字节)，IP头部最长是60字节。
- 服务类型：3位优先权、4位TOS，1位保留。优先权无视，4位TOS分别表示：最小延迟、最大吞吐量、最高可靠性和最小费用。最多只能一个能置位。
- 总长度：单位是字节。IP数据包的总长度，优于MTU限制，这个总长度不会达到最大值的。
- 标识：数据报唯一标识，每发送一个数据报，值加1。每个分片的数据报标识是相同的。
- 标志位： 第一位保留，第二位(Dont Fragment, DF)禁止分片，第三位(More Fragment, MF)更多分片，除了数据报的最后一个分片，其他分片都要置位。
- 分片偏移：分片(数据部分)相对位置，实际偏移值是左移3位。这样使得每个IP分片的数据部分长度都必须是8的整数倍。
- 生存时间(TTL)：数据报到达目的地之前允许的跳数。
- 协议：用于区分上层协议、ICMP(1)、TCP(5)、UDP(17)

IP数据报的`option`字段，最多包含40字节，可用的选项：

- 记录路由(record route): 数据报途径的路由都应将自己的IP地址填入option。
- 时间戳：每个路由器应将数据报被转发的时间填入option
- 松散路由选择: 指定一个路由器IP地址列表，发送过程中必须经过其中所有的路由器。
- 严格源路由选择：松散路由的基础上，加一个只能经过该列表的路由器的条件。

> IP数据报在linux用tcpdump命令抓取

## 3. IP分片

以太网帧的MTU是1500字节(包括IP头部)。

IP数据报封装一个长度1481字节的ICMP报文(8字节ICMP头)

![IP数据报分片](http://cdn.lentme.cn/20220809211439.png)

### 4. IP路由

IP协议的核心任务接收路由，决定数据报的发送路径。

![IP模块基本工作流程](http://cdn.lentme.cn/20220809211630.png)

### 5. 转发

### 6. 重定向路由表

ICMP重定向报文能够更新路由表。

#### ICMP重定向报文格式

![ICMP重定向报文](http://cdn.lentme.cn/20220809212642.png)

ICMP重定向报文类型值是5。

ICMP重定向报文数据部分：

- 引起重定向的IP数据报的源端IP地址
- 应该使用的路由器的IP地址

接收主机根据数据部分更新路由表。
