## 1. TCP/IP协议族

TCP/IP协议族是四层协议系统，自底向上分别是`链路层`、`网络层`、`传输层`和`应用层`

![TCP/IP协议族](http://cdn.lentme.cn/202208091454811.jpg)

### 1.1 链路层

链路层实现了网卡接口的网络驱动程序，以处理数据在物理媒介上传输。

链路层两个常用的协议：

- ARP协议(Address Resolve Protocol，地址解析协议)
- RARP协议(Reverse Addresss Resolve Protocol, 逆地址解析协议)

> 实现了IP地址和机器物理地址(MAC)之间的相互转换。

### 1.2 网络层

网络层实现了数据包的选路和转发。向上层协议隐藏了网络拓扑连接的细节，使得在上层看来，通信的双方是直连的。

网络层协议：IP协议(Internet Protocol, 因特网协议)。

> IP协议根据数据包的目的IP选择下一跳(路由)。

网络层协议：ICMP协议(Internet Control Message Protocol, 因特网控制报文协议)。

> IP协议的补充，用于检测网络连接。(ping命令)

![ICMP报文格式](http://cdn.lentme.cn/202208091502233.png)

ICMP报文分类：

| 类型名称   | 报文用途                                           |
| ---------  | ---------                                          |
| 差错报文   | 回应网络错误，如目标不可达(type=4)和重定向(type=5) |
| 查询报文   | 查询网络信息(ping程序type=8)                       |

ICMP代码分了：
| 代码名称   | 代码备注             |
| ---------  | ----------           |
| 重定向报文 | 对网络重定向(type=0) |
| 主机重定向 | type=1               |

16位校验字段使用`循环冗余校验和`。

### 1.3 传输层

传输层为两台主机上的应用程序提供端到端的通信。

![传输层和网络层](http://cdn.lentme.cn/202208091509079.png)

传输层协议：TCP协议、UDP协议和SCTP协议。

#### TCP协议

TCP协议(Transmission Control Protocol, 传输控制协议)为应用层提供可靠的、面向连接的和基于流的服务。

TCP使用`超时重传`、`数据确认`等方式来确保数据包被正确地发送至目的端，因此TCP服务是可靠的。

基于流的数据没有边界限制，发送端可以逐个字节地向数据流写入数据，接收端也可以逐个字节地将它们读出。

#### UDP协议

UDP协议(User Datagram Protocol, 用户数据报协议)为应用层提供不可靠、无连接和基于数据包的服务。

UDP是无连接的，所以每次发送数据都要明确指定接收端的信息。(IP地址等), 每个UDP数据包都有一个长度，接收端必须以该长度为最小单位将其所有内容一次性读出，否则数据将被截断。

#### SCTP协议

SCTP协议(Stream Control Transmission Protocol, 流控制传输协议)是因特网上传输电话信号而设计的。

### 1.4 应用层

应用层负责处理应用程序的逻辑。

## 2. 封装

封装实现了上层协议使用下层协议提供的服务。每层协议在上层数据的基础上加上自己的头部信息和可能包含的尾部信息，以实现该层的功能，这个过程称为封装。

![封装](http://cdn.lentme.cn/202208091533653.png)

经过TCP封装后的数据称为`TCP报文段`，其包含了TCP头部信息和TCP发送缓冲区的数据。

当发送端调用`send`(或`write`)函数向一个TCP连接写入数据时，内核中的TCP模块会先把数据复制到与该连接对应的TCP内核发送缓冲区中，然后TCP模块调用IP模块提供的服务传递TCP报文段。

UDP封装的叫UDP数据报。

IP封装的数据称为IP数据报，包含了头部信息和数据部分。数据部分就是一个TCP报文段、UDP数据报或ICMP报文。

链路层封装的数据称为帧。以太网上传输的是以太网帧(ethernet frame)，令牌环网络上传输的是令牌环帧(token ring frame)

![以太网帧](http://cdn.lentme.cn/202208091556208.png)

以太网帧类型：

| 类型名            | 字段值 |
| ------            | ------ |
| IP数据报          | 0x800  |
| ARP请求或应答报文 | 0x806  |
| RARP请求或应答    | 0x835  |

帧最大传输单元(Max Transimit Unit, MTU)，即帧最多能够携带多少来自上层协议的数据，不包括头部。通常是`1500B`，通常搞的是IP数据报，所以才会有分片的IP数据报。

## 3. 分用

封装的反操作就是`分用`，依靠头部信息中的类型字段实现。

![以太网帧分用](http://cdn.lentme.cn/202208091559171.png)

以太网帧用帧类型字段来区别分用的实现。

IP数据报用16位的协议字段来区分TCP、UDP、ICMP。

TCP和UDP用头部的16位端口号来区分上层应用程序。


## 5. ARP协议工作原理

ARP实现了能实现任意网路层地址到物理地址的转换。

工作原理：主机向自己所在网络广播一个ARP请求，请求包含了目标机器的网络地址，网络上的所有机器都会收到该请求，但只有目标机器会响应包含了自己物理地址的ARP应答。

#### 5.1 ARP报文

![ARP报文](http://cdn.lentme.cn/202208091608783.png)

- 硬件类型： 1表示MAC地址。
- 映射目的协议地址类型：0x800表示IP地址。
- 长度：单位是字节。
- 操作类型：ARP请求(1)、ARP应答(2)、RARP请求(3)和RARP应答(4)

#### ARP高速缓存

ARP维护一个高速缓存，包含经常访问或最近访问的机器的地址映射。

Linux可以使用`arp`命令查看和修改高速缓存。

> 查看某一时刻的ARP缓存命令：arp -a
> arp 命令都在bind包里面，arch安装命令：sudo pacman -S bind

## 6. DNS工作原理

DNS是一套分布式的域名服务系统。每个DNS服务器都存放着大量的机器名和IP地址的映射，并且是动态更新的。

DNS报文：

![DNS报文](http://cdn.lentme.cn/202208091619391.png)

16位标识字段用于标记一对请求和应答。

16位标志字段用于协商具体的通信方式和反馈通信状态。

![标志字段](http://cdn.lentme.cn/202208091621956.png)

- QR: 查询、应答标志。0标识查询，1标识应答。
- opcode：定义查询和应答的类型。0是标准查询，1是反向查询，2是请求服务器状态。
- AA：授权应答标志，由应答报文使用，1标识域名服务器是授权服务器。
- TC：截断标志，UDP传输时，数据报有长度限制，所以需要一个标志位用来处理截断。
- RD：递归查询标志。1是递归执行，0是迭代执行。
- RA: 允许递归标志，仅应答使用。
- rcode: 返回码。常用无错误(0)、域名不存在(3)

### socket和TCP/IP协议族

socket提供的两点功能：

1. 实现应用程序的用户缓冲区和TCP/UDP内核发送、接收缓冲区交换数据。(send、recv函数)。
2. 应用程序通过socket修改内核中各层协议的头部信息或其他数据结构。
