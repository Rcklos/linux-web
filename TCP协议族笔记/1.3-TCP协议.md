# TCP协议

- TCP头：每个TCP段的开头，指定通信的源端端口号、目的端端口号，管理TCP连接，控制两个方向的数据流。
- TCP状态转移过程：TCP连接的任意一端都是一个状态机，从TCP建立连接到断开的整个过程都会经历不同的状态变迁。
- TCP数据流：分与交互数据流和成块数据流，还有一种特殊数据称为紧急数据。
- TCP数据流的控制：为了保证可靠传输和提高网络通信质量而对TCP数据流进行控制。主要有`超时重传`和`拥塞控制`。

## 1. TCP服务特点

传输层协议主要有TCP和UDP。

TCP是点对点的，无连接的UDP适合广播和多播。

基于TCP服务的应用程序执行读操作次数和TCP模块接收到的TCP报文段个数之间没有固定的数量关系。

> 流式协议不相信包的概念

![传输层协议服务](http://cdn.lentme.cn/20220809220535.png)

TCP传输是可靠的。TCP的`应答机制`确保了每个TCP报文段都能够被成功接收，其次，`超时重传`机制也规定了一定时间内未收到应答，则重发报文段。

## 2. TCP头部结构

TCP头部用于指定双方端口、管理连接等。

### 2.1 TCP固定头部结构

![TCP头部结构](http://cdn.lentme.cn/20220809220925.png)

头部长度: 单位是32bit，即4个字节，由于只有四位，最大可表示的值是15，故TCP报文段最长可有15*4=60字节。

六位标志位：

- URG: 紧急指针(urgent pointer)
- ACK: 确认报文段
- PSH: 提示接收端应用程序应立即将TCP接收缓冲区的数据读走。
- RST: 复位标志，重新建立连接。
- SYN: 请求建立连接。
- FIN: 结束报文段

窗口大小: TCP流量控制的一个手段。TCP头通常是接收窗口。
紧急指针: 正偏移量，与序列号字段相加表示最后一个紧急数据的下一字节的序号。

### 2.2 TCP头部选项

TCP头部的最后一个字段是可变长的可选信息，最多包含40字节(受4位头部长度限制)

![TCP选项](http://cdn.lentme.cn/20220810090352.png)

选项字段：

| kind                | [length]   | info...                                                    |
| ----                | -------    | -------                                                    |
| 选项类型            | 选项总长度 | 选项的具体信息                                             |
| 结束选项(0)         |            |                                                            |
| NOP(1)              |            | 空操作                                                     |
| 最大报文段(2)       |            | Max Segment Size(MESS)通常设置MSS为MTU-40(1460)            |
| 窗口扩大因子(3)     |            | TCP连接初始化时使用,假设窗口大小N,扩大因子M, 实际窗口N*2^M |
| 选择性确认(4)       |            | 改善重复发送已正确传输的TCP报文段的情况(SACK)              |
| SACK实际工作选项(5) |            | 告知已接收的数据块，需要发送端检查并重发丢失的数据块。     |
| 时间戳选项(8)       |            | 提供了较为准确的计算通信双方之间的贿赂事件(RTT)            |

> 最大报文段和扩大因子都只能在SYNC报文段中，选择性确认也用在连接初始化时

## 3. TCP连接的建立与关闭

### 3.1 三次握手四次挥手

![TCP三次握手四次挥手](http://cdn.lentme.cn/20220810141030.png)

### 3.2 半关闭状态

TCP全双工，允许两个方向的数据被独立关闭。

> 四次挥手会经历这段状态

![半关闭状态](http://cdn.lentme.cn/20220810141434.png)

> read() 返回0表示收到结束报文段, shuntdown()函数提供了半关闭的支持。

### 3.3 连接超时

连接超时一般会进行重连，一次或多次重连无效则会通知应用程序连接超时。

> 超时时间是可以修改的

## 4. TCP状态转移

TCP连接的任意一段都处于某种状态。

> 查看状态命令：netstat

![状态转换图](http://cdn.lentme.cn/20220810141747.png)

客户端和服务器端的状态转换：

![TCP的CS状态转换](http://cdn.lentme.cn/20220810142111.png)

## 5. 复位报文段

特殊条件下，TCP连接的一端会发送RST标志的报文段，以通知对方关闭或重新建立连接。

复位产生的3种情况：

1. 访问不存在端口
2. 异常终止连接
    > 可以用socket的SO_LINGER来发送复位报文段以异常终止连接。
3. 处理半打开连接

## 6. TCP交互数据流

TCP报文段的数据按照长度分为两种：`交互数据流`和`成块数据`。

> 交互数据对实时性要求高，如telnet、ssh等
> 成块数据流长度通常为MSS，对传输效率要求高，如ftp

实时交互会产生大量微小报文段。

> 对于互联网大量的微小报文段可能会造成拥塞，简单高效的方法是Nagle算法。

## 7. TCP成块数据流

> 一般是搞ftp

## 8. 带外数据

传输层协议具有带外数据的概念（Out Of Band, OOB），用于迅速通告对方本端发生的重要事件。

> 通常外带数据比普通数据(带内)具有更高的优先级，应总是立即被发送。
> UDP没有实现，TCP也没有实现真正的带外数据，但可以用UG实现。

## 9. TCP超时重传

TCP服务必须能够重传超时时间内未收到确认的TCP段。

每一个TCP段都会维护一个重传定时器，该定时器在TCP段第一次发送时启动。

> linux TCP在底层接管前最少重传次数默认是3次，在连接放弃前默认最多可以执行15次重传。

> 快速重传指的是在报文段超时之前重传。

## 10. 拥塞控制

拥塞控制为TCP提高网络利用率，降低丢包率，且保证网络资源对每条数据流的公平性。

拥塞控制的四个部分： 慢启动(slow start)、拥塞避免(congestion avoidance)、快速重传(fast retransmit)和快速回复(fast revovery)。

### 10.1 拥塞控制概述

拥塞控制最终受控变量是发送窗口(SWND, send window)。

SWDN限定了连续发送的报文段数量，这些报文段的最大长度(SMSS, Sender Maximum Segment Size)的值一般等于MESS。

- SWDN太小，网络延迟大
- SWND太大，容易导致拥塞

接收窗口(RWND)不够满足控制SWND，故提供拥塞窗口(Congestion Window, CWND)。

![CWDN闭环反馈控制](http://cdn.lentme.cn/20220810153931.png)

### 10.2 慢启动和拥塞避免

TCP连接建立后，CWDN被设置成IW(Initial Window)。

> 为减少传输滞后，Linux内核已经提高了该初始值。

建立后，发送端最多能发送IW字节的数据，伺候接收端只需回复一个确认，假设未确认的字节数是N，

CWDN按下式增加：

```
CWND += min(N, SMSS)
```

`慢启动门限`防止慢启动的CWND快速膨胀而导致网路拥塞，从而实现拥塞避免。

![慢启动和拥塞避免](http://cdn.lentme.cn/20220810154858.png)

判断网络拥塞的依据：

- 传输超时或者TCP重传定制器溢出。
- 接收到重复的确认报文段

第一种情况仍然使用慢启动和拥塞避免。

第二种情况采用快速重传和快速恢复(发生拥塞的情况)

超时重传会做出如下调整：

![图中FlightSize就是上述的N](http://cdn.lentme.cn/20220810155603.png)

### 10.3 快速重传和快速恢复

发送端一般连续收到多个(3个)重复确认报文段的时候，就认为是拥塞发生了。

处理步骤：

1. 用上述公式计算ssthresh，然后立即重传丢失的报文段，并按照下述公式计算CWND。
    ![cwnd重计算](http://cdn.lentme.cn/20220810160032.png)
2. 每次收到1个重复确认时，设置CWND = CWND + SMSS。
3. 每次收到新数据的确认时，设置CWND = ssthresh

然后后续就恢复到慢启动和拥塞避免阶段。
